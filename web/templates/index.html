<!DOCTYPE html>
<html>
<head>
    <title>Asuka connecting..</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <link href="/static/asuka.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div style="max-width: 1500px;margin: 20px auto;display: none"
     id="vue-content">
    <div class="head_wrap" v-if="basic.time">
        <div class="head-item">
            <div>
                <h1>{{"{{basic.mem_sys}}"}}</h1>
                <small>Memory usage</small>
            </div>
            <br>
            <table>
                <tbody>
                <tr>
                    <td>
                        Time
                    </td>
                    <td>
                        <strong>{{"{{basic.time}}"}}</strong>
                    </td>
                    <td>
                        Uptime
                    </td>
                    <td>
                        <strong>{{"{{basic.uptime}}"}}</strong>
                    </td>
                </tr>
                <tr>
                    <td>
                        Servers
                    </td>
                    <td>
                        <strong>{{"{{basic.server_enable}}"}}</strong>
                    </td>
                    <td>
                        Offline
                    </td>
                    <td>
                        <strong>
                            {{"{{basic.server_enable?((basic.server_enable-basic.server_run)/basic.server_enable*100).toFixed(2):0}}"}}
                            %
                        </strong>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="head-item">
            <div>
                <h1>{{"{{basic.queue|numberFormat}}"}}</h1>
                <small>All url in redis</small>
                <span style="float: right"><strong>{{"{{basic.redis_mem}}"}}</strong></span>
            </div>
            <br>
            <table>
                <tbody>
                <tr>
                    <td>
                        socket / ws
                    </td>
                    <td>
                        <strong>{{"{{basic.connections|numberFormat}}"}}
                            / {{"{{basic.ws_connections|numberFormat}}"}}</strong>
                    </td>
                    <td>
                        Goroutine
                    </td>
                    <td>
                        <strong>{{"{{basic.goroutine|numberFormat}}"}}</strong>
                    </td>
                </tr>
                <tr>
                    <td>Retries</td>
                    <td colspan="3">
                        <strong>{{"{{retries}}"}}</strong>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="head-item">
            <div style="float:right">
                <h1>{{"{{basic.traffic_out}}"}}</h1>
                <small>TCP traffic out</small>
            </div>
            <div>
                <h1>{{"{{basic.traffic_in}}"}}</h1>
                <small>TCP traffic in</small>
            </div>
            <br>
            <table>
                <tbody>
                <tr>
                    <td>
                        Request
                    </td>
                    <td>
                        <strong>{{"{{basic.access_count|numberFormat}}"}}</strong>
                    </td>
                    <td>
                        Failed
                    </td>
                    <td>
                        <strong>{{"{{basic.failure_count|numberFormat}}"}}</strong>
                    </td>
                </tr>
                <tr>
                    <td>
                        Failure Recent
                    </td>
                    <td>
                        <strong>{{"{{ projects.length?(basic.failure_period/projects.length):0 |numberFormat }}"}}
                            %</strong>
                    </td>
                    <td>
                        Failure All
                    </td>
                    <td>
                        <strong>{{"{{ basic.access_count?(basic.failure_count/basic.access_count)*100:0 |numberFormat }}"}}
                            %</strong>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div style="width: 100%;height:145px;">{{/*防止下面延迟加载成功后的抖动*/}}
        <canvas style="width: 100%;height:140px;" id="chart-legend-top"></canvas>
    </div>
    <div style="background: #fff;padding: 30px 20px;overflow-x: auto" v-if='projects.length'>
        <table class="table-striped">
            <thead>
            <tr>
                <th style="width: 1px"></th>
                <th>Project</th>
                <th>Servers</th>
                <th>Offline</th>
                <th>Failure recent/all</th>
                <th>Dispatch</th>
                <th>Load 60s/15m</th>
                {{/*<th>Pass/Sleep</th>*/}}
                <th>Traffic I/O</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="item,index in projects" style="cursor: pointer"
                :class="{ stop: item.stop}">
                <td class="center" v-on:click="goTo(item.name)">{{"{{index+1}}"}}</td>
                <td class="center" v-on:click="goTo(item.name)"><a :href="item.name">{{"{{item.name}}"}}</a></td>
                <td class="center" v-on:click="goTo(item.name)">{{"{{item.server_run}}"}}
                    / {{"{{item.server_enable}}"}}
                </td>
                <td class="center"
                    v-on:click="goTo(item.name)">{{"{{item.server_enable?((item.server_enable-item.server_run)/item.server_enable*100).toFixed(2):0}}"}}
                    %
                </td>
                <td class="center" v-on:click="goTo(item.name)">{{"{{item.failure_period|numberFormat}}"}}%
                    / {{"{{item.failure_all|numberFormat}}"}}%
                </td>
                <td class="center" v-on:click="goTo(item.name)">{{"{{item.access_count}}"}}
                    / {{"{{item.failure_count}}"}}</td>
                <td class="center" v-on:click="goTo(item.name)">{{"{{item.loads['60']|numberFormat}}"}}
                    / {{"{{item.loads['900']|numberFormat}}"}}</td>
                {{/*<td class="center" v-on:click="goTo(item.name)">{{"{{item.waiting}}"}} / {{"{{item.sleep}}"}}</td>*/}}
                <td class="center" v-on:click="goTo(item.name)">{{"{{item.traffic_in}}"}}
                    / {{"{{item.traffic_out}}"}}</td>
                <td class="right ctl">
                    <button class="btn-sm ctl" :disabled="item._btnDisabled"
                            :class="{orange:!item.stop,green:item.stop}"
                            style="color:#fff"
                            v-on:click.stop.prevent="switchProject(item)">{{"{{item.stop?'start':'stop'}}"}}</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <br>
    <div style="color: #dadada;padding: 0 20px 40px">
        <div>
            <span v-if="basic.uptime">Uptime: {{"{{basic.uptime}}"}}  Date: {{"{{basic.date}}"}}</span>
            <span v-if="basic.filter_new_connections">new conn: {{"{{basic.filter_new_connections}}"}}</span>
        </div>
        <div>
            <span v-if="basic.sys_load">Load: {{"{{basic.sys_load}}"}}</span>
            <span v-if="basic.sys_mem">Used/Total: {{"{{basic.sys_mem}}"}} <span
                        :style="{color: 'hsl('+(100-basic.sys_mem_percent)+', 100%, 35%)'}">{{"{{basic.sys_mem_percent.toFixed(2)}}"}}%</span></span>
            <span v-if="basic.runtime_mem">Sys/Alloc: {{"{{basic.runtime_mem}}"}}</span>
        </div>
        <div>
            <span v-if="basic.tcp_filter.load">Load: {{"{{basic.tcp_filter.load}}"}}</span>
            <span v-if="basic.tcp_filter.mem_total">Used/Total: {{"{{(basic.tcp_filter.mem_total-basic.tcp_filter.mem_available)|fileSizeH}}"}}/{{"{{basic.tcp_filter.mem_total|fileSizeH}}"}} <span
                        :style="{color: 'hsl('+(100-(basic.tcp_filter.mem_total-basic.tcp_filter.mem_available)/basic.tcp_filter.mem_total*100)+', 100%, 35%)'}">{{"{{((basic.tcp_filter.mem_total-basic.tcp_filter.mem_available)/basic.tcp_filter.mem_total*100).toFixed(2)}}"}}%</span></span>
            <span v-if="basic.tcp_filter.mem_sys">Sys/Alloc: {{"{{basic.tcp_filter.mem_sys|fileSizeH}}"}}/{{"{{basic.tcp_filter.mem_alloc|fileSizeH}}"}}</span>
        </div>
        <div>
            <span v-if="basic.tcp_filter.mem_rss">Rss: {{"{{basic.tcp_filter.mem_rss|fileSizeH}}"}}</span>
            <span v-if="basic.tcp_filter.goroutine">Goroutine: {{"{{basic.tcp_filter.goroutine}}"}}</span>
            <span v-if="basic.tcp_filter.goroutine">Alive: {{"{{basic.tcp_filter.bl_alive_size}}"}}</span>
            <span v-if="basic.tcp_filter.goroutine">Test: {{"{{basic.tcp_filter.bl_test_count}}"}}</span>
            <span v-if="basic.tcp_filter.goroutine">Pool: {{"{{basic.tcp_filter.pool_size}}"}}</span>
            <span v-if="basic.tcp_filter.goroutine">Sockets: {{"{{basic.tcp_filter.sockets}}"}}</span>
        </div>
    </div>

    <div class="ctrl-wrap">
        {{if not .Check}}
            <a href="/login">
                <button class="btn-mb" style="background: #ff9c38;border: 1px solid #ff9c38;color: #fff">Login</button>
            </a>
        {{else}}
            <button v-on:click="logout()" class="btn-mb"
                    style="background: #ff9c38;border: 1px solid #ff9c38;color: #fff">Logout
            </button>
        {{end}}
        <input type="text" v-on:keypress="sendCommand($event)" class="inp-mb" placeholder="console" value=""
               style="max-width: 160px">
    </div>
</div>
<script src="/static/asuka.js?v=2"></script>
<script>
    let timer_d90g8df987g9dfg7df9gdfj, ws, manualFlag = false, vueContent,
        wsUrl = (window.location.protocol === "https:" ? "wss://" : "ws://") + window.location.host + "/index.io";
    loadScript("/static/vue.min.js", function () {
        vueContent = new Vue({
            el: "#vue-content",
            data: {
                basic: {
                    tcp_filter: {}
                },
                projects: [],
                chart1: null,
                action: "",
            },
            methods: {
                goTo: function (name) {
                    location.href = "/" + name
                },
                switchProject: function (item) {
                    this.$set(item, '_btnDisabled', true);
                    ajax({
                        url: "/switchProject", data: {name: item.name}, error: function (res) {
                            if (res.status === 401) {
                                location.href = "/login"
                            }
                        }
                    });
                },
                logout: function () {
                    ajax({
                        url: "/logout", success: function () {
                            location.reload()
                        }
                    });
                },
                sendCommand: function (evt) {
                    if (evt.key && evt.key.toLocaleLowerCase() === "enter") {
                        sendMessage(evt.target.value);
                    }
                }
            },
            computed: {
                retries: function () {
                    let str = "", k;
                    for (k in this.basic.queue_bls) {
                        if (this.basic.queue_bls.hasOwnProperty(k)) {
                            str += (k == -1 ? "F:" : "") + " " + this.basic.queue_bls[k] + " / "
                        }
                    }
                    return str ? str.substring(0, str.length - 2) : str
                },
            },
            filters: {
                numberFormat: function (v) {
                    if (v === undefined || isNaN(v)) {
                        return "0"
                    }
                    return new Intl.NumberFormat().format(v)
                }, fileSizeH: function (size) {
                    return fileSizeH(size);
                }
            },
            mounted: function () {
                handlerSocket();
                document.getElementById('vue-content').style.display = "block";
                loadScript('/static/Chart.min.js', function () {
                    setTimeout(function () {
                        isMobile() ? sendMessage("4") : sendMessage("2")//change refresh rate
                    }, 5000)
                });
            }
        });
    });
</script>
</body>
</html>